# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AI-powered chat web app with Microsoft Entra ID authentication and Azure AI Foundry Agent Service integration. Single-container deployment on Azure Container Apps.

## Commands

### Frontend (from `frontend/`)
```bash
npm install --legacy-peer-deps   # Install (--legacy-peer-deps required for React 19)
npm run dev                      # Vite dev server on :5173, proxies /api to :8080
npm run build                    # TypeScript check + Vite production build
npm run lint                     # ESLint (no auto-fix)
```

### Backend (from `backend/WebApp.Api/`)
```bash
dotnet watch run                 # Dev server on :8080 with hot reload
dotnet build                     # Build
dotnet test                      # Run tests (from backend/)
```

### Full Stack Local Dev
```bash
# Option 1: VS Code compound task (Ctrl+Shift+B → "Start Dev")
# Option 2: PowerShell script
.\deployment\scripts\start-local-dev.ps1
# Option 3: Run both manually in separate terminals
```

### Deployment (Azure Developer CLI)
```bash
azd up                           # Full deploy: infra + code (~10-12 min)
azd deploy                       # Code-only deploy (~3-5 min)
azd provision                    # Infrastructure only / update RBAC
azd down --force --purge         # Teardown all Azure resources
```

## Architecture

| Layer | Tech | Port | Entry Point |
|-------|------|------|-------------|
| Frontend | React 19 + TypeScript + Vite 7 | 5173 | `frontend/src/App.tsx` |
| Backend | ASP.NET Core 9 Minimal APIs | 8080 | `backend/WebApp.Api/Program.cs` |
| Auth | MSAL.js (PKCE) → JWT Bearer | — | `frontend/src/config/authConfig.ts` |
| AI SDK | Azure.AI.Projects + Agent Framework | — | `backend/.../Services/AgentFrameworkService.cs` |
| Deploy | Azure Container Apps (single container) | — | `infra/main.bicep` |

**Key flow**: React SPA → MSAL token → `POST /api/chat/stream` → AI Foundry Agent → SSE chunks → UI

### Single-Container Pattern
Production: Vite builds React to static files → ASP.NET Core serves them from `wwwroot` alongside the API. Both live in one Docker image (`deployment/docker/frontend.Dockerfile` — multi-stage: Node build → .NET build → runtime).

### Frontend Architecture
- **State**: Centralized `AppContext` with `useReducer` + typed discriminated-union actions (`frontend/src/reducers/appReducer.ts`). Dev-mode logging middleware logs state diffs.
- **Components**: Container/Presentation split — `AgentPreview.tsx` (state wiring) → `ChatInterface.tsx` (stateless UI) → chat subcomponents in `frontend/src/components/chat/`.
- **Streaming**: `ChatService` class (`frontend/src/services/chatService.ts`) uses `fetch` + `ReadableStream` reader for SSE. Supports `AbortController` cancellation and retry with exponential backoff.
- **Path alias**: `~` maps to `frontend/src/` in Vite config.
- **UI library**: Fluent UI v9 + `@fluentui-copilot` components.

### Backend Architecture
- **Minimal API** endpoints defined inline in `Program.cs` (no controllers).
- **SSE streaming**: Writes `text/event-stream` events directly to `HttpResponse` with manual flush. Event types: `conversationId`, `chunk`, `annotations`, `mcpApprovalRequest`, `usage`, `done`, `error`.
- **Auth**: `Microsoft.Identity.Web` validates JWT with dual audience (`api://{clientId}` and `{clientId}`). Policy `RequireChatScope` requires `Chat.ReadWrite` scope.
- **AI integration**: `AgentFrameworkService` wraps `Azure.AI.Projects` SDK (beta) for agent loading and streaming. Uses `ChainedTokenCredential` (AzureCLI locally, ManagedIdentity in production).

### API Endpoints
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/chat/stream` | POST | Send message, receive SSE streaming response |
| `/api/agent` | GET | Get agent metadata (name, description, starter prompts) |
| `/api/agent/info` | GET | Debug info about loaded agent |
| `/api/health` | GET | Authenticated health check |

### Environment Variables
**Backend** (`.env` in project root, auto-generated by `azd up`):
- `ENTRA_SPA_CLIENT_ID`, `ENTRA_TENANT_ID` — Auth config
- `AI_AGENT_ENDPOINT`, `AI_AGENT_ID` — AI Foundry connection

**Frontend** (`frontend/.env.local`, auto-generated by `azd up`):
- `VITE_ENTRA_SPA_CLIENT_ID`, `VITE_ENTRA_TENANT_ID` — Build-time only (accessed via `import.meta.env.VITE_*`)

Vite config also reads from `.azure/{envName}/.env` if present (azd environment store).

## Key Dependencies
- `Azure.AI.Projects` v1.2.0-beta.5 and `Microsoft.Agents.AI.AzureAI` v1.0.0-preview — beta SDKs, APIs may change
- React 19 requires `--legacy-peer-deps` for npm install; explicitly add peer deps like `yjs` in `package.json`
- Office documents (DOCX/PPTX/XLSX) are not supported for upload

## Infrastructure
Bicep templates in `infra/` deploy: Azure Container Apps, ACR (Basic), Log Analytics, system-assigned Managed Identity. Deployment hooks in `deployment/hooks/` handle Entra app registration, AI Foundry discovery, and RBAC assignment via PowerShell.
